# 智能打印机后台设计 V0.1

标签（空格分隔）： QG项目

---

[TOC]

## 功能设计
终端是分为 打印机，Web，app。Web 和 App 与 服务器的交互基于 HTTP 协议；打印机与服务器的交互基于Tcp 协议（短连接）。


### 服务器-打印机 （双向通信）

#### 服务器到打印机

1. 批次     订单（计时 与 容量） （计时 与 容量策略自动变化）（短连接， 和嵌入式协商通信的主动权）
3. 加急订单 ： （加急区）
4. 智能分发管理 （后期增加）

**问题**
>  1. 如何区分加急订单与普通订单 ：  通道 与 标志
>  2. 加急订单也是单次订单吗 ： 只是单次订单
>  3. 向打印机发送数据的前提条件是：打印机的内存容量需要多大呢？ 在打印完一定量的订单后要返回一个服务器标志 ： 可以继续接收数据

-----------
**对异常情况的处理**

1.  打印机异常
    * 打印机无法发送数据：订单状态未知 （打印完一份订单回传，打印完一份批次回传，定时回传。数据标志）
    * 打印机发送异常数据：订单状态明确错误 （提示：轮询查询订单错误，前期实现）
> 处理方式：

2.  服务器异常 （嵌入式模块）
    * 打印机发送数据，服务器内部错误
    * 打印机发送数据，服务器连接关闭
> 处理方式：

3. 异常处理：记录异常情况，对于异常订单，再由客户主动向服务器请求。

#### 打印机到服务器

1. 订单打印状态  （下载完成，进入缓存（加急缓存与普通缓存），进入打印队列，打印开始，订单异常（**打印异常**（漏单，重单....），其他异常），打印完成）。可以跟踪一个订单整个生命周期
2. 打印机当前状态（健康，亚健康，异常）
3. 打印机内存状态 

**能够记录这些异常**

**问题**
> 1. 这些状态并不具体。需要具体化，或者半具体化。

### 服务器-Web

1. 获取订单状态
2. 增加加急订单
3. logo设定

4. 本地下单 （无网络状态）
5. 对异常订单的处理
    * 重新向服务器发送打印订单的请求
    * 直接将异常订单数据使用本地打印功能

### 服务器-app （更加简单）

1. 获取订单状态
2. 增加加急订单
1. logo 设定待定  （后期实现）
2. 本地下单 （蓝牙使用） （后期实现）

### 本地-打印机 （串口通信）

## 数据格式设计

### 服务器-打印机

**订单数据**
1. 订单编号             （9bytes）[订单编辑好为全球唯一编号，3bytes：主控板id， 3bytes：服务器发给主控板的时间；3bytes：主控板单日打印的订单序号]
2. 订单长度             （2bytes）
3. 订单优先级           （1bytes）
4. 所属批次             （1bytes）
5. 批次内序号           （1bytes）
6. 打印机编号           （1bytes）
7. 服务器的订单发送时间 （6bytes）
8. 打印机的订单接收时间 （6bytes）
9. 打印机编号           （1bytes）

**批次数据**
1. 批次编号
2. 批次长度
3. 订单个数
4. 服务器的批次发送时间
5. 打印机的批次接收时间

**加急订单**



**发送订单数据时需要的其他判断数据**
1. 每批次订单发送的间隔时间 
2. 缓存区剩余容量大小
3. 打印机的请求数据

> PS: 状态数据做成可拓展功能，后期可以增加状态

**订单打印状态**
1. 下载完成
2. 进入缓存（加急缓存与普通缓存）
3. 进入打印队列
4. 打印开始
5. 订单异常
    * 打印异常
        * 漏单，重单等等
    * 其他异常
6. 打印完成

**打印机状态**

1. 健康
2. 亚健康
3. 异常

### 服务器-打印机




